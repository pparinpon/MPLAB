#include <xc.h>
#include <pic16f18346.h>
#include <pic.h>

#include "eeprom_header.h"
#include "struct_header.h"
#include "command_header.h"
#include "calibrate_mode.h"
#include "spi_header.h"

__EEPROM_DATA(0x00,0x00,0x00,0x00,0x01,0x45,0x43,0x4F); 
__EEPROM_DATA(0x42,0x4F,0x54,0x20,0x4C,0x43,0x43,0x2E); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00); 
__EEPROM_DATA(0x01,0x00,0x00,0x00,0x00,0x02,0x00,0x00); 
__EEPROM_DATA(0x00,0x01,0x00,0x00,0x00,0x00,0x03,0x03); //write spec 
__EEPROM_DATA(0x01,0x00,0x28,0x03,0x02,0x00,0x64,0x03); 
__EEPROM_DATA(0x03,0x00,0x48,0x03,0x04,0x00,0xC8,0x03); 
__EEPROM_DATA(0x05,0x00,0x00,0x03,0x06,0x00,0x52,0x03); 

__EEPROM_DATA(0x07,0x00,0x00,0x02,0x08,0x00,0x02,0x09); 
__EEPROM_DATA(0x00,0x02,0x0A,0x01,0x03,0x0B,0x00,0x00); 
__EEPROM_DATA(0x03,0x0C,0x00,0x00,0x03,0x0D,0x00,0xB4); 
__EEPROM_DATA(0x03,0x0E,0x00,0x00,0x03,0x0F,0x00,0x00); 
__EEPROM_DATA(0x03,0x10,0x00,0x00,0x03,0x11,0x00,0x00); 
__EEPROM_DATA(0x03,0x12,0x00,0x00,0x03,0x13,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 

__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 

__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 
__EEPROM_DATA(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00); 


#define EEPROMSTAddr 0xF000
#define EEPROMENDAddr 0xF0FF

unsigned char RaadData[2];
int EEPROM_ADDR_buf = 0;
int SIZE_COUNT;
bit isMyAddr = 0;
void ReadEEPROM (int addr)
{
    unsigned char Hiadr = addr >> 8 & 0xFF;
    unsigned char Loadr = addr & 0xFF;
    NVMCON1bits.NVMREGS = 1;
    NVMADRL = Loadr;
    NVMADRH = Hiadr;
    NVMCON1bits.RD = 1;    
    RD = 1;       
    // Set read bit
    RaadData[0] = NVMDATL;
    RaadData[1] = NVMDATH;
}



void EEPROM_download(unsigned char spi1_Read_data){
    unsigned int bufint  = spi1_Read_data;
    unsigned long buflong = spi1_Read_data;
    cargoData = getCargoData();
    if(isMycargo){
        switch(countabuf){
            case 0:
                cargoData.cargoLength = (bufint << 8 | 0x00FF);
                break;
            case 1:
                cargoData.cargoLength = cargoData.cargoLength & (bufint  | 0xFF00);
                break;
            case 2:
                cargoData.command = spi1_Read_data;
                break;
            case 3:
                cargoData.index = spi1_Read_data;
                break;
            case 4:
                cargoData.address = spi1_Read_data;
                if(cargoData.address != linkInfo.My_address){
                    restartCargo();
                    isMycargo = 0;
                }else{
                    LATAbits.LATA0 = ~LATAbits.LATA0; 
                    isMyAddr = 1;
                    EEPROM_ADDR_buf = EEPROMSTAddr;
                }
                break;
        }
    }
        if(isMyAddr && countabuf > 4){           
//            if((countabuf-1) % 2 == 0){
                ReadEEPROM (EEPROM_ADDR_buf);
                spi2_Send_data = RaadData[0];               
//            }else{
//                spi2_Send_data = RaadData[1];
                EEPROM_ADDR_buf += 1;
//            }
        }
        countabuf++;  
        if(calibdata.cargoLength <= countabuf){
        calibdata.cargoLength = 0xFFFF;
        countabuf = 0;
        isMycargo = 1;
        isMyAddr = 0;
        }

    if(EEPROMENDAddr <= EEPROM_ADDR_buf){
        countabuf = 0;
        isMycargo = 1;
    }
}
